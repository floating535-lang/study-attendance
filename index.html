<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìŠ¤í„°ë”” ì¶œì„í‘œ (ì˜¤í”„ ì œë„ í¬í•¨)</title>
    <style>
        * { box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Malgun Gothic', Arial, sans-serif; 
            margin: 0;
            padding: 20px; 
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 { 
            text-align: center; 
            color: #333;
            margin-bottom: 10px;
        }
        
        /* ğŸ†• íƒ­ ë©”ë‰´ ìŠ¤íƒ€ì¼ */
        .tab-menu {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 20px 0 30px 0;
            border-bottom: 2px solid #e0e0e0;
        }
        .tab-button {
            padding: 12px 30px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: #666;
            transition: all 0.3s;
        }
        .tab-button:hover {
            color: #4CAF50;
        }
        .tab-button.active {
            color: #4CAF50;
            border-bottom-color: #4CAF50;
        }
        
        /* ğŸ†• ì›”ë³„ ì¡°íšŒ ì»¨íŠ¸ë¡¤ */
        .archive-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin: 20px 0;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
        }
        .archive-controls label {
            font-weight: 600;
            color: #333;
        }
        .archive-controls select {
            padding: 10px 20px;
            font-size: 16px;
            border: 2px solid #4CAF50;
            border-radius: 5px;
            background: white;
            cursor: pointer;
            min-width: 200px;
        }
        .archive-controls select:focus {
            outline: none;
            border-color: #45a049;
            box-shadow: 0 0 5px rgba(76, 175, 80, 0.3);
        }
        
        /* íƒ­ ì½˜í…ì¸  */
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        
        .last-update {
            text-align: center;
            color: #666;
            font-size: 14px;
            margin-bottom: 30px;
        }
        .rules-box {
            background-color: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 30px;
        }
        .rules-box h3 {
            margin-top: 0;
            color: #856404;
        }
        .rules-box ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        .rules-box li {
            margin: 5px 0;
        }
        .loading {
            text-align: center;
            padding: 50px;
            font-size: 18px;
            color: #666;
        }
        .error {
            text-align: center;
            padding: 50px;
            color: #d32f2f;
        }
        table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 30px;
            font-size: 14px;
        }
        th, td { 
            border: 1px solid #ddd; 
            padding: 12px 8px; 
            text-align: center; 
        }
        th { 
            background-color: #4CAF50;
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        th.member-name {
            background-color: #2196F3;
            min-width: 130px;
        }
        td.member-name-cell {
            min-width: 130px;
            max-width: 180px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* ì¶œì„ ìƒíƒœë³„ ìŠ¤íƒ€ì¼ */
        .attended { 
            background-color: #e8f5e9;
            color: #2e7d32;
            font-weight: bold;
        }
        .absent { 
            background-color: #ffebee;
            color: #c62828;
            font-weight: bold;
        }
        .off {
            background-color: #fff9c4;
            color: #f57f17;
            font-weight: bold;
        }
        .long-off {
            background-color: #e1f5fe;
            color: #0277bd;
            font-weight: bold;
        }
        .future { 
            background-color: #f5f5f5;
            color: #999;
        }
        
        .summary { 
            margin-top: 30px; 
            padding: 20px; 
            border: 2px solid #4CAF50;
            border-radius: 8px;
            background-color: #f1f8e9;
        }
        .summary h2 {
            margin-top: 0;
            color: #2e7d32;
        }
        .member-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .member-card {
            padding: 15px;
            background: white;
            border-radius: 5px;
            border-left: 4px solid #4CAF50;
        }
        .member-card.warning {
            border-left-color: #ff9800;
        }
        .member-card.penalty {
            border-left-color: #f44336;
        }
        .warning-text { 
            color: #ff9800;
            font-weight: bold;
        }
        .penalty-text { 
            color: #f44336;
            font-weight: bold;
        }
        .off-text {
            color: #f57f17;
            font-weight: normal;
        }
        .long-off-text {
            color: #0277bd;
            font-weight: normal;
        }
        .download-icon {
            cursor: pointer;
            text-decoration: none;
            font-size: 16px;
            margin-left: 5px;
        }
        .download-icon:hover {
            transform: scale(1.2);
            display: inline-block;
        }
        
        /* ë²”ë¡€ */
        .legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .legend-box {
            width: 30px;
            height: 30px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        /* ë°˜ì‘í˜• ë””ìì¸ */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            td.member-name-cell {
                white-space: normal;
                word-break: keep-all;
            }
            table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
                -webkit-overflow-scrolling: touch;
            }
            th, td {
                padding: 8px 4px;
                font-size: 12px;
            }
            .tab-button {
                padding: 10px 20px;
                font-size: 14px;
            }
            .archive-controls {
                flex-direction: column;
            }
            .archive-controls select {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 id="mainTitle">ğŸ“š ìŠ¤í„°ë”” ì¶œì„í‘œ (ì˜¤í”„ ì œë„ í¬í•¨)</h1>
        
        <!-- ğŸ†• íƒ­ ë©”ë‰´ -->
        <div class="tab-menu">
            <button class="tab-button active" onclick="switchTab('current')">
                ğŸ“… í˜„ì¬ ì›”
            </button>
            <button class="tab-button" onclick="switchTab('archive')">
                ğŸ“ ì›”ë³„ ì¡°íšŒ
            </button>
        </div>
        
        <!-- í˜„ì¬ ì›” íƒ­ ì½˜í…ì¸  -->
        <div id="currentTab" class="tab-content active">
            <div class="last-update">
                ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: <span id="lastUpdate">-</span>
            </div>
            
            <div class="rules-box">
                <h3>ğŸ“‹ ì¶œì„ ê·œì¹™</h3>
                <ul>
                    <li><strong>ì¶œì„ ì¸ì •</strong>: ë‹¹ì¼ ìì •ê¹Œì§€ íŒŒì¼ ì—…ë¡œë“œ (ë˜ëŠ” ë‹¤ìŒ ë‚  ìƒˆë²½ 3ì‹œê¹Œì§€ "ì œì¶œ ëŒ€ê¸°" ìƒíƒœ)</li>
                    <li><strong>ì˜¤í”„(ğŸ–ï¸)</strong>: ì£¼ 3íšŒê¹Œì§€ í—ˆìš© (ì´ˆê³¼ ì‹œ ìë™ ê²°ì„ ì²˜ë¦¬)</li>
                    <li><strong>ì¥ê¸°ì˜¤í”„(ğŸï¸)</strong>: ë³„ë„ ì‚¬ìœ ë¡œ ì¥ê¸° íœ´ì‹ (ì£¼ê°„ í•œë„ ì œì™¸)</li>
                    <li><strong>ê²°ì„(X)</strong>: ë¯¸ì œì¶œ ë˜ëŠ” ì˜¤í”„ í•œë„ ì´ˆê³¼</li>
                </ul>
            </div>

            <div class="legend">
                <div class="legend-item">
                    <div class="legend-box attended">O</div>
                    <span>ì¶œì„</span>
                </div>
                <div class="legend-item">
                    <div class="legend-box off">ğŸ–ï¸</div>
                    <span>ì˜¤í”„</span>
                </div>
                <div class="legend-item">
                    <div class="legend-box long-off">ğŸï¸</div>
                    <span>ì¥ê¸°ì˜¤í”„</span>
                </div>
                <div class="legend-item">
                    <div class="legend-box absent">X</div>
                    <span>ê²°ì„</span>
                </div>
                <div class="legend-item">
                    <div class="legend-box future">-</div>
                    <span>ë¯¸ë˜ ë‚ ì§œ</span>
                </div>
            </div>

            <div id="loadingIndicator" class="loading">
                â³ ì¶œì„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
            </div>

            <div id="errorContainer" class="error" style="display: none;">
                âŒ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨<br>
                <span id="errorMessage"></span>
            </div>

            <div id="contentContainer" style="display: none;">
                <!-- ì¶œì„í‘œ -->
                <h2 style="text-align: center;"><span id="currentMonth"></span> ì¶œì„í‘œ</h2>
                <table id="attendanceTable">
                    <thead>
                        <tr id="dateHeaderRow">
                            <th class="member-name">ì¡°ì›ëª…</th>
                        </tr>
                    </thead>
                    <tbody id="attendanceTableBody">
                    </tbody>
                </table>

                <!-- ì›”ë³„ ìš”ì•½ -->
                <div class="summary">
                    <h2><span id="summaryMonth"></span> ì¶œì„ ìš”ì•½ (<span id="totalDays"></span>ì¼ ê¸°ì¤€)</h2>
                    <div id="monthlySummary" class="member-summary"></div>
                </div>

                <!-- ì´ë²ˆ ì£¼ ì˜¤í”„ ì‚¬ìš© í˜„í™© -->
                <div class="summary">
                    <h2>ğŸ–ï¸ ì´ë²ˆ ì£¼ ì˜¤í”„ ì‚¬ìš© í˜„í™©</h2>
                    <div id="weeklyOffSummary" class="member-summary"></div>
                </div>
            </div>
        </div>
        
        <!-- ğŸ†• ì›”ë³„ ì¡°íšŒ íƒ­ ì½˜í…ì¸  -->
        <div id="archiveTab" class="tab-content">
            <div class="archive-controls">
                <label for="monthSelector">ğŸ“ ì¡°íšŒí•  ì›” ì„ íƒ:</label>
                <select id="monthSelector" onchange="loadArchiveMonth()">
                    <option value="">-- ì›”ì„ ì„ íƒí•˜ì„¸ìš” --</option>
                </select>
            </div>
            
            <div id="archiveLoading" class="loading" style="display: none;">
                â³ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
            </div>
            
            <div id="archiveError" class="error" style="display: none;"></div>
            
            <div id="archiveContent" style="display: none;">
                <h2 style="text-align: center;">
                    <span id="archiveMonthTitle"></span> ì¶œì„í‘œ
                </h2>
                
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-box attended">O</div>
                        <span>ì¶œì„</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-box off">ğŸ–ï¸</div>
                        <span>ì˜¤í”„</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-box long-off">ğŸï¸</div>
                        <span>ì¥ê¸°ì˜¤í”„</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-box absent">X</div>
                        <span>ê²°ì„</span>
                    </div>
                </div>
                
                <table id="archiveTable">
                    <thead>
                        <tr id="archiveDateHeaderRow">
                            <th class="member-name">ì¡°ì›ëª…</th>
                        </tr>
                    </thead>
                    <tbody id="archiveTableBody">
                    </tbody>
                </table>
                
                <!-- ì›”ë³„ ìš”ì•½ -->
                <div class="summary">
                    <h2><span id="archiveSummaryMonth"></span> ì¶œì„ ìš”ì•½</h2>
                    <div id="archiveMonthlySummary" class="member-summary"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ğŸ†• API URL ì„¤ì •
        const API_URL = 'https://script.google.com/macros/s/YOUR_DEPLOYMENT_ID/exec';
        
        // ===== í˜„ì¬ ë‚ ì§œ ê¸°ì¤€ =====
        const now = new Date();
        const year = now.getFullYear();
        const month = now.getMonth();
        const currentDay = now.getDate();
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        // ===========================================
        // ğŸ†• íƒ­ ì „í™˜ í•¨ìˆ˜
        // ===========================================
        function switchTab(tabName) {
            // íƒ­ ë²„íŠ¼ í™œì„±í™”
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // íƒ­ ì½˜í…ì¸  í‘œì‹œ
            document.getElementById('currentTab').classList.remove('active');
            document.getElementById('archiveTab').classList.remove('active');
            
            if (tabName === 'current') {
                document.getElementById('currentTab').classList.add('active');
            } else if (tabName === 'archive') {
                document.getElementById('archiveTab').classList.add('active');
                // ì²˜ìŒ ì—´ ë•Œë§Œ ì›” ëª©ë¡ ë¡œë“œ
                if (document.getElementById('monthSelector').options.length <= 1) {
                    loadArchiveList();
                }
            }
        }

        // ===========================================
        // ğŸ†• ë°±ì—…ëœ ì›” ëª©ë¡ ë¡œë“œ
        // ===========================================
        async function loadArchiveList() {
            try {
                const response = await fetch(`${API_URL}?action=list_archives`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success && result.archives && result.archives.length > 0) {
                    const selector = document.getElementById('monthSelector');
                    
                    // ê¸°ì¡´ ì˜µì…˜ ì œê±° (ì²«ë²ˆì§¸ ì œì™¸)
                    while (selector.options.length > 1) {
                        selector.remove(1);
                    }
                    
                    // ë°±ì—… ì›” ì˜µì…˜ ì¶”ê°€
                    result.archives.forEach(monthName => {
                        const option = document.createElement('option');
                        option.value = monthName;
                        option.textContent = monthName;
                        selector.appendChild(option);
                    });
                } else {
                    document.getElementById('archiveError').textContent = 
                        'ğŸ“‚ ì•„ì§ ë°±ì—…ëœ ì›”ì´ ì—†ìŠµë‹ˆë‹¤.';
                    document.getElementById('archiveError').style.display = 'block';
                }
                
            } catch (error) {
                console.error('ì›” ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
                document.getElementById('archiveError').textContent = 
                    `âŒ ì›” ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨: ${error.message}`;
                document.getElementById('archiveError').style.display = 'block';
            }
        }

        // ===========================================
        // ğŸ†• ì„ íƒí•œ ì›” ë°ì´í„° ë¡œë“œ
        // ===========================================
        async function loadArchiveMonth() {
            const selector = document.getElementById('monthSelector');
            const monthName = selector.value;
            
            if (!monthName) {
                document.getElementById('archiveContent').style.display = 'none';
                return;
            }
            
            // UI ì´ˆê¸°í™”
            document.getElementById('archiveLoading').style.display = 'block';
            document.getElementById('archiveError').style.display = 'none';
            document.getElementById('archiveContent').style.display = 'none';
            
            try {
                const url = `${API_URL}?action=get_archive&month=${encodeURIComponent(monthName)}`;
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.error) {
                    throw new Error(result.message || 'ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨');
                }
                
                // ë¡œë”© ìˆ¨ê¸°ê¸°
                document.getElementById('archiveLoading').style.display = 'none';
                
                // ë°ì´í„° ë Œë”ë§
                renderArchiveTable(result.data, monthName);
                
                document.getElementById('archiveContent').style.display = 'block';
                
            } catch (error) {
                console.error('ì›”ë³„ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                document.getElementById('archiveLoading').style.display = 'none';
                document.getElementById('archiveError').textContent = 
                    `âŒ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ${error.message}`;
                document.getElementById('archiveError').style.display = 'block';
            }
        }

        // ===========================================
        // ğŸ†• ë°±ì—… ë°ì´í„° ë Œë”ë§
        // ===========================================
        function renderArchiveTable(data, monthName) {
            // ì›” ì´ë¦„ì—ì„œ ë…„/ì›” ì¶”ì¶œ
            const match = monthName.match(/^(\d{4})ë…„ (\d{1,2})ì›”/);
            if (!match) return;
            
            const archiveYear = parseInt(match[1]);
            const archiveMonth = parseInt(match[2]) - 1;
            const archiveDaysInMonth = new Date(archiveYear, archiveMonth + 1, 0).getDate();
            
            document.getElementById('archiveMonthTitle').textContent = monthName;
            document.getElementById('archiveSummaryMonth').textContent = `${match[2]}ì›”`;
            
            // í—¤ë” ìƒì„±
            const headerRow = document.getElementById('archiveDateHeaderRow');
            headerRow.innerHTML = '<th class="member-name">ì¡°ì›ëª…</th>';
            
            for (let day = 1; day <= archiveDaysInMonth; day++) {
                const date = new Date(archiveYear, archiveMonth, day);
                const dayOfWeek = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '][date.getDay()];
                const isWeekend = date.getDay() === 0 || date.getDay() === 6;
                
                const th = document.createElement('th');
                th.innerHTML = `${day}<br><small>${dayOfWeek}</small>`;
                if (isWeekend) {
                    th.style.backgroundColor = '#ff9800';
                }
                headerRow.appendChild(th);
            }
            
            // ì¶œì„ ë°ì´í„° í–‰ ìƒì„±
            const tbody = document.getElementById('archiveTableBody');
            tbody.innerHTML = '';
            
            const summaryDiv = document.getElementById('archiveMonthlySummary');
            summaryDiv.innerHTML = '';
            
            for (const memberName in data) {
                const member = data[memberName];
                const row = document.createElement('tr');
                
                // ì¡°ì›ëª…
                const nameCell = document.createElement('td');
                nameCell.className = 'member-name-cell';
                nameCell.textContent = memberName;
                row.appendChild(nameCell);
                
                // í†µê³„
                let attended = 0, absent = 0, off = 0, longOff = 0;
                
                // ë‚ ì§œë³„ ì¶œì„ ìƒíƒœ
                for (let day = 1; day <= archiveDaysInMonth; day++) {
                    const dayData = member.ê¸°ë¡ && member.ê¸°ë¡[day.toString()];
                    const cell = document.createElement('td');
                    
                    if (!dayData || !dayData.status) {
                        cell.textContent = '-';
                        cell.className = 'future';
                    } else {
                        const status = dayData.status;
                        
                        if (status === 'O') {
                            cell.textContent = 'O';
                            cell.className = 'attended';
                            attended++;
                        } else if (status === 'OFF') {
                            cell.textContent = 'ğŸ–ï¸';
                            cell.className = 'off';
                            off++;
                        } else if (status === 'LONG_OFF') {
                            const reason = dayData.reason || '';
                            cell.textContent = 'ğŸï¸';
                            cell.className = 'long-off';
                            if (reason) cell.title = reason;
                            longOff++;
                        } else {
                            cell.textContent = 'X';
                            cell.className = 'absent';
                            absent++;
                        }
                    }
                    
                    row.appendChild(cell);
                }
                
                tbody.appendChild(row);
                
                // ìš”ì•½ ì¹´ë“œ
                const card = document.createElement('div');
                card.className = 'member-card';
                
                const penaltyCount = Math.floor(absent / 3);
                if (penaltyCount > 0) {
                    card.classList.add('penalty');
                }
                
                card.innerHTML = `
                    <strong style="font-size: 16px;">${escapeHtml(memberName)}</strong><br>
                    <span style="color: #2e7d32;">âœ… ì¶œì„: ${attended}ì¼</span> | 
                    <span style="color: #c62828;">âŒ ê²°ì„: ${absent}ì¼</span><br>
                    <span class="off-text">ğŸ–ï¸ ì˜¤í”„: ${off}ì¼</span> | 
                    <span class="long-off-text">ğŸï¸ ì¥ê¸°: ${longOff}ì¼</span>
                    ${penaltyCount > 0 ? `<br><span class="penalty-text">âš ï¸ í˜ë„í‹°: ${penaltyCount}íšŒ</span>` : ''}
                `;
                
                summaryDiv.appendChild(card);
            }
        }

        // ===========================================
        // ê¸°ì¡´ í•¨ìˆ˜ë“¤ (í˜„ì¬ ì›”ìš©)
        // ===========================================
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(date) {
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
        }

        function renderDateHeaders() {
            const headerRow = document.getElementById('dateHeaderRow');
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dayOfWeek = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '][date.getDay()];
                const isWeekend = date.getDay() === 0 || date.getDay() === 6;
                
                const th = document.createElement('th');
                th.innerHTML = `${day}<br><small>${dayOfWeek}</small>`;
                if (isWeekend) {
                    th.style.backgroundColor = '#ff9800';
                }
                headerRow.appendChild(th);
            }
        }

        function getThisWeekRange() {
            const today = new Date(year, month, currentDay);
            const dayOfWeek = today.getDay();
            const monday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
            const weekStart = new Date(year, month, currentDay + monday);
            
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekStart.getDate() + 6);
            
            const result = {
                start: weekStart.getDate(),
                end: Math.min(weekEnd.getDate(), daysInMonth),
                startsInPrevMonth: false,
                prevMonth: null,
                prevMonthYear: null,
                prevMonthStart: null
            };
            
            if (weekStart.getMonth() !== month) {
                result.startsInPrevMonth = true;
                result.prevMonth = weekStart.getMonth();
                result.prevMonthYear = weekStart.getFullYear();
                result.prevMonthStart = weekStart.getDate();
                result.start = 1;
            }
            
            return result;
        }

        function renderAttendanceTable(data, prevMonthData) {
            const tbody = document.getElementById('attendanceTableBody');
            tbody.innerHTML = '';
            
            const monthlySummaryDiv = document.getElementById('monthlySummary');
            monthlySummaryDiv.innerHTML = '';
            
            const weeklyOffSummaryDiv = document.getElementById('weeklyOffSummary');
            weeklyOffSummaryDiv.innerHTML = '';

            const weekRange = getThisWeekRange();

            for (const memberName in data) {
                const member = data[memberName];
                const row = document.createElement('tr');
                
                const nameCell = document.createElement('td');
                nameCell.className = 'member-name-cell';
                nameCell.textContent = memberName;
                row.appendChild(nameCell);

                let attended = 0, absent = 0, off = 0, longOff = 0, thisWeekOff = 0;
                const offDates = [];

                for (let day = 1; day <= daysInMonth; day++) {
                    const dayData = member.ê¸°ë¡ && member.ê¸°ë¡[day.toString()];
                    const cell = document.createElement('td');
                    
                    if (day > currentDay) {
                        cell.textContent = '-';
                        cell.className = 'future';
                    } else if (!dayData || !dayData.status) {
                        cell.textContent = 'X';
                        cell.className = 'absent';
                        absent++;
                    } else {
                        const status = dayData.status;
                        
                        if (status === 'O') {
                            cell.innerHTML = `<a href="${dayData.link}" target="_blank" class="download-icon" title="íŒŒì¼ ë³´ê¸° (${dayData.fileCount}ê°œ)">O</a>`;
                            cell.className = 'attended';
                            attended++;
                        } else if (status === 'OFF') {
                            cell.textContent = 'ğŸ–ï¸';
                            cell.className = 'off';
                            off++;
                            
                            let isThisWeek = false;
                            if (weekRange.startsInPrevMonth) {
                                if (day >= 1 && day <= weekRange.end) {
                                    isThisWeek = true;
                                }
                            } else {
                                if (day >= weekRange.start && day <= weekRange.end) {
                                    isThisWeek = true;
                                }
                            }
                            
                            if (isThisWeek) {
                                thisWeekOff++;
                                offDates.push({ display: `${month + 1}/${day}`, month: month, day: day });
                            }
                        } else if (status === 'LONG_OFF') {
                            const reason = dayData.reason || '';
                            cell.textContent = 'ğŸï¸';
                            cell.className = 'long-off';
                            if (reason) cell.title = reason;
                            longOff++;
                        } else {
                            cell.textContent = 'X';
                            cell.className = 'absent';
                            absent++;
                        }
                    }
                    
                    row.appendChild(cell);
                }

                // ì „ì›” ë°ì´í„°ì—ì„œ ì´ë²ˆ ì£¼ ì˜¤í”„ í™•ì¸
                if (weekRange.startsInPrevMonth && prevMonthData && prevMonthData[memberName]) {
                    const prevMember = prevMonthData[memberName];
                    const prevMonthDays = new Date(weekRange.prevMonthYear, weekRange.prevMonth + 1, 0).getDate();
                    
                    for (let prevDay = weekRange.prevMonthStart; prevDay <= prevMonthDays; prevDay++) {
                        const prevDayStatus = prevMember.ê¸°ë¡ && prevMember.ê¸°ë¡[prevDay.toString()];
                        if (prevDayStatus && prevDayStatus.status === 'OFF') {
                            thisWeekOff++;
                            offDates.unshift({
                                display: `${weekRange.prevMonth + 1}/${prevDay}`,
                                month: weekRange.prevMonth,
                                day: prevDay
                            });
                        }
                    }
                }

                tbody.appendChild(row);

                // ì›”ë³„ ìš”ì•½ ì¹´ë“œ
                const card = document.createElement('div');
                card.className = 'member-card';
                
                const penaltyCount = Math.floor(absent / 3);
                if (penaltyCount > 0) {
                    card.classList.add('penalty');
                }
                
                card.innerHTML = `
                    <strong style="font-size: 16px;">${escapeHtml(memberName)}</strong><br>
                    <span style="color: #2e7d32;">âœ… ì¶œì„: ${attended}ì¼</span> | 
                    <span style="color: #c62828;">âŒ ê²°ì„: ${absent}ì¼</span><br>
                    <span class="off-text">ğŸ–ï¸ ì˜¤í”„: ${off}ì¼</span> | 
                    <span class="long-off-text">ğŸï¸ ì¥ê¸°: ${longOff}ì¼</span>
                    ${penaltyCount > 0 ? `<br><span class="penalty-text">âš ï¸ í˜ë„í‹°: ${penaltyCount}íšŒ</span>` : ''}
                `;
                
                monthlySummaryDiv.appendChild(card);

                // ì£¼ê°„ ì˜¤í”„ í˜„í™©
                if (thisWeekOff > 0) {
                    const weeklyCard = document.createElement('div');
                    weeklyCard.className = 'member-card';
                    
                    if (thisWeekOff >= 3) {
                        weeklyCard.classList.add('penalty');
                    } else if (thisWeekOff >= 2) {
                        weeklyCard.classList.add('warning');
                    }
                    
                    const offDatesText = offDates.map(d => d.display).join(', ');
                    
                    let offStatusText = '';
                    if (thisWeekOff > 3) {
                        const excess = thisWeekOff - 3;
                        const convertedDates = offDates.slice(-excess).map(d => d.display).join(', ');
                        offStatusText = `<span style="color: #f44336; font-weight: bold;">ğŸš¨ í•œë„ ì´ˆê³¼ (${thisWeekOff}/3íšŒ)</span><br><span style="color: #f44336;">â†’ ê²°ì„ ì²˜ë¦¬: ${convertedDates}</span>`;
                    } else if (thisWeekOff >= 3) {
                        offStatusText = `<span style="color: #f44336; font-weight: bold;">ğŸš¨ í•œë„ ë„ë‹¬ (${thisWeekOff}/3íšŒ)</span>`;
                    } else if (thisWeekOff >= 2) {
                        offStatusText = `<span style="color: #ff9800; font-weight: bold;">âš ï¸ ì£¼ì˜ (${thisWeekOff}/3íšŒ)</span>`;
                    } else {
                        offStatusText = `<span style="color: #4CAF50;">âœ… ì •ìƒ (${thisWeekOff}/3íšŒ)</span>`;
                    }
                    
                    weeklyCard.innerHTML = `
                        <strong style="font-size: 16px;">${escapeHtml(memberName)}</strong><br>
                        ${offStatusText}
                        <div style="margin-top: 8px; font-size: 14px; color: #666;">ì˜¤í”„ ì‚¬ìš©ì¼: <strong>${offDatesText}</strong></div>
                    `;
                    weeklyOffSummaryDiv.appendChild(weeklyCard);
                }
            }

            if (weeklyOffSummaryDiv.children.length === 0) {
                weeklyOffSummaryDiv.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">ì´ë²ˆ ì£¼ ì˜¤í”„ë¥¼ ì‚¬ìš©í•œ ì¡°ì›ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
            }
        }

        async function loadAttendanceData() {
            try {
                const dataUrl = `${API_URL}?month=${year}-${String(month + 1).padStart(2, '0')}`;
                
                const response = await fetch(dataUrl);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                const data = await response.json();
                
                let prevMonthData = null;
                const weekRange = getThisWeekRange();
                
                if (weekRange.startsInPrevMonth) {
                    const prevMonth = month === 0 ? 11 : month - 1;
                    const prevYear = month === 0 ? year - 1 : year;
                    const prevMonthUrl = `${API_URL}?month=${prevYear}-${String(prevMonth + 1).padStart(2, '0')}`;
                    
                    try {
                        const prevResponse = await fetch(prevMonthUrl);
                        if (prevResponse.ok) {
                            prevMonthData = await prevResponse.json();
                        }
                    } catch (error) {
                        console.warn('ì „ì›” ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                    }
                }

                document.getElementById('loadingIndicator').style.display = 'none';
                document.getElementById('contentContainer').style.display = 'block';
                
                renderAttendanceTable(data, prevMonthData);
                document.getElementById('lastUpdate').textContent = formatDate(new Date());

            } catch (error) {
                console.error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                document.getElementById('loadingIndicator').style.display = 'none';
                document.getElementById('errorContainer').style.display = 'block';
                document.getElementById('errorMessage').textContent = error.message;
            }
        }

        // ===== ì´ˆê¸°í™” =====
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('currentMonth').textContent = `${year}ë…„ ${month + 1}ì›”`;
            document.getElementById('summaryMonth').textContent = `${month + 1}ì›”`;
            document.getElementById('totalDays').textContent = currentDay;
            
            renderDateHeaders();
            loadAttendanceData();
        });
    </script>
</body>
</html>
